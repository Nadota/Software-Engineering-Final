<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentorship | AlumniConnect</title>
    <link rel="stylesheet" href="styles.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        .search-container { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .mentor-card { padding: 20px; border-bottom: 1px solid var(--border-color); transition: 0.2s; cursor: pointer; }
        .mentor-card:hover { background-color: #f7f9f9; }
        .mentor-header { display: flex; gap: 12px; margin-bottom: 10px; }
        .mentor-avatar { width: 48px; height: 48px; background: #eff3f4; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .mentor-info h3 { margin: 0; font-size: 16px; color: var(--text-main); }
        .mentor-info p { margin: 2px 0 0; color: var(--text-secondary); font-size: 14px; }
        .tags { display: flex; gap: 8px; margin: 10px 0 15px 60px; }
        .tag { background-color: #eff3f4; color: var(--text-secondary); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .btn-request { margin-left: 60px; padding: 8px 16px; border: 1px solid #cfd9de; background: white; border-radius: 20px; font-weight: bold; color: var(--btn-black); cursor: pointer; transition: 0.2s; }
        .btn-request:hover { background-color: #eff3f4; }
    </style>
</head>
<body>

<div class="layout">
    <header class="sidebar">
        <div>
            <div class="nav-link" style="width: 50px; height: 50px; justify-content: center;">
                 <i class='bx bxs-network-chart' style="font-size: 30px;"></i>
            </div>
            <nav>
                <a href="home.html" class="nav-link">
                    <i class='bx bxs-home-circle'></i> <span>Home</span>
                </a>
                <a href="connect.html" class="nav-link">
                    <i class='bx bx-search'></i> <span>Connect</span>
                </a>
                <a href="mentorship.html" class="nav-link active">
                    <i class='bx bx-group'></i> <span>Mentorship</span>
                </a>
                <a href="notifications.html" class="nav-link">
                    <i class='bx bx-bell'></i> <span>Notifications</span>
                </a>
                <a href="profile.html" class="nav-link">
                    <i class='bx bx-user'></i> <span>Profile</span>
                </a>
            </nav>
            <button onclick="window.location.href='home.html'" class="sidebar-post-btn">Post</button>
        </div>
        <div id="sidebarUser" class="user-pill">
            <div class="user-avatar-sm">G</div>
            <div class="user-meta">
                <span class="post-name">Guest</span>
                <span class="user-handle" style="font-size: 13px;">@guest_123</span>
            </div>
        </div>
    </header>

    <main class="main-feed">
        <div class="feed-header">
            <span class="feed-title">Find a Mentor</span>
        </div>

        <div class="search-container">
            <div class="search-box" style="width: 100%; background: #eff3f4;">
                <i class='bx bx-search'></i>
                <input type="text" placeholder="Search by name or company...">
            </div>
        </div>

        <div id="mentor-list-container">
            <div style="padding:20px; text-align:center; color:#536471;">Loading mentors...</div>
        </div>
    </main>

    <aside class="right-sidebar">
        <div class="search-box">
            <i class='bx bx-search'></i>
            <input type="text" placeholder="Search AlumniConnect">
        </div>
    </aside>
</div>

<div id="requestModal" class="modal">
    <div class="modal-content">
        <h2 style="font-size: 20px; margin-bottom: 10px;">Request Mentorship</h2>
        <p style="color: var(--text-secondary); margin-bottom: 15px;">
            Message to <b id="modalMentorName">...</b>
        </p>
        <div class="input-container">
            <textarea id="requestMsg" rows="4" class="composer-textarea" placeholder="Why are you seeking mentorship?" style="border:1px solid #cfd9de; padding:10px; border-radius:8px; font-size:16px;"></textarea>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
            <button onclick="closeModal()" style="font-weight: bold; color: var(--text-main);">Cancel</button>
            <button id="sendBtn" onclick="submitRequest()" class="post-submit-btn active" style="width: auto; padding: 10px 20px;">Send</button>
        </div>
    </div>
</div>

<script type="module">
    import { supabase } from './supabase.js';

    window.openModal = openModal;
    window.closeModal = closeModal;
    window.submitRequest = submitRequest;

    const mentorContainer = document.getElementById('mentor-list-container');
    const modal = document.getElementById('requestModal');
    const nameSpan = document.getElementById('modalMentorName');
    const msgInput = document.getElementById('requestMsg');
    const sendBtn = document.getElementById('sendBtn');
    
    let currentMentor = '';

    // --- 1. FETCH MENTORS FROM DATABASE ---
    async function loadMentors() {
        const { data, error } = await supabase
            .from('mentors')
            .select('*');

        if (error) {
            mentorContainer.innerHTML = '<div style="padding:20px; text-align:center;">Error loading mentors.</div>';
            console.error(error);
            return;
        }

        if (data.length === 0) {
            mentorContainer.innerHTML = '<div style="padding:20px; text-align:center;">No mentors found in database.</div>';
            return;
        }

        mentorContainer.innerHTML = ''; // Clear loading message

        data.forEach(mentor => {
            // Split tags string by comma (if it exists)
            const tagsArray = mentor.tags ? mentor.tags.split(',') : [];
            const tagsHTML = tagsArray.map(tag => `<span class="tag">${tag.trim()}</span>`).join('');

            const html = `
                <div class="mentor-card">
                    <div class="mentor-header">
                        <div class="mentor-avatar">${mentor.name[0]}</div>
                        <div class="mentor-info">
                            <h3>${mentor.name}</h3>
                            <p>${mentor.job} @ ${mentor.company}</p>
                        </div>
                    </div>
                    <div class="tags">
                        ${tagsHTML}
                    </div>
                    <button class="btn-request" onclick="openModal('${mentor.name}')">Request Mentorship</button>
                </div>
            `;
            mentorContainer.innerHTML += html;
        });
    }

    // --- 2. MODAL FUNCTIONS ---
    function openModal(name) {
        currentMentor = name;
        nameSpan.innerText = name;
        modal.style.display = 'block';
    }

    function closeModal() {
        modal.style.display = 'none';
        msgInput.value = '';
    }

    async function submitRequest() {
        const message = msgInput.value;
        if(!message) return alert("Please enter a message");

        sendBtn.innerText = "Sending...";
        sendBtn.disabled = true;

        const { error } = await supabase
            .from('mentorship_requests')
            .insert([{ mentor_name: currentMentor, message: message, status: 'Pending' }]);

        if (error) {
            console.error(error);
            alert("Error sending request!");
        } else {
            alert("Request sent successfully!");
            closeModal();
        }

        sendBtn.innerText = "Send";
        sendBtn.disabled = false;
    }

    window.onclick = function(event) {
        if (event.target == modal) closeModal();
    }

    // Load Data
    loadMentors();
</script>

</body>
</html>
